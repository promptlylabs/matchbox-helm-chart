# Default values for matchbox.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

replicaCount: 1

image:
  repository: europe-west6-docker.pkg.dev/ahdis-ch/ahdis/matchbox
  pullPolicy: Always
  # Overrides the image tag whose default is the chart appVersion.
  tag: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Automatically mount a ServiceAccount's API credentials?
  automount: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

podAnnotations:
  kube-score/ignore: container-security-context-readonlyrootfilesystem,pod-probes-identical

podLabels: {}

podSecurityContext: {}

securityContext:
  # Spring Boot/HAPI FHIR requires write access for temp files, caching, and Hibernate
  # TODO: Investigate using emptyDir volumes for /tmp to enable readOnlyRootFilesystem: true
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

service:
  type: ClusterIP
  port: 8080

ingress: {}
# Example ingress configuration:
# enabled: true
# className: "nginx"
# annotations:
#   nginx.ingress.kubernetes.io/ssl-redirect: "true"
#   cert-manager.io/cluster-issuer: "letsencrypt-prod"
# hosts:
#   - host: matchbox.example.com
#     paths:
#       - path: /
#         pathType: Prefix
# tls:
#   - secretName: matchbox-tls
#     hosts:
#       - matchbox.example.com

resources: {}
  # Recommended for production/staging with IG loading:
  # limits:
  #   cpu: 2000m
  #   memory: 4Gi
  # requests:
  #   cpu: 1000m
  #   memory: 2500Mi

startupProbe:
  httpGet:
    path: /v4/actuator/health/liveness
    port: http
  initialDelaySeconds: 15
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6

livenessProbe:
  httpGet:
    path: /v4/actuator/health/liveness
    port: http
  initialDelaySeconds: 15
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /v4/actuator/health/readiness
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 3
  targetCPUUtilizationPercentage: 80
  # targetMemoryUtilizationPercentage: 80
  behavior: {}

strategy: {}
  # type: RollingUpdate
  # rollingUpdate:
  #   maxSurge: 0
  #   maxUnavailable: 1

# Pod Disruption Budget
pdb:
  enabled: false
  # Minimum available pods during voluntary disruptions (recommended: 33% for HA)
  # NOTE: minAvailable and maxUnavailable are mutually exclusive
  # If minAvailable is set, maxUnavailable will be ignored
  minAvailable: 33%
  # Alternative: maximum unavailable pods (only used if minAvailable is not set)
  # maxUnavailable: 1

# Additional volumes on the output Deployment definition.
volumes: []

# Additional volumeMounts on the output Deployment definition.
volumeMounts: []

nodeSelector: {}

tolerations: []

affinity: {}

networkPolicy:
  # Default allows all traffic. For production, consider restricting:
  # Ingress: Allow from nginx-ingress namespace
  # Egress: Allow to PostgreSQL, tx.fhir.org (terminology server), simplifier.net (IG packages)
  ingress:
    - {}
  egress:
    - {}

# Direct environment variables
env: []
#  - name: JAVA_OPTS
#    value: "-Xmx2g"

# Additional secrets with environment variables
secretNames: []
#  - matchbox-db-secret

# Matchbox specific configuration
matchbox:
  server:
    servlet:
      context-path: '/v4'

  matchbox:
    fhir:
      context:
        httpReadOnly: true
        txServer: https://tx.fhir.org/r4

  # Example: PostgreSQL DB configuration (default is H2 in-memory)
  # spring:
  #   datasource:
  #     url: "jdbc:postgresql://<host>:<port>/<database>"
  #     username: # set via environment variable from secret
  #     password: # set via environment variable from secret
  #     driverClassName: org.postgresql.Driver
  #   jpa:
  #     properties:
  #       hibernate:
  #         dialect: org.hibernate.dialect.PostgreSQLDialect

  # Example: FHIR Implementation Guides to preload
  # hapi:
  #   fhir:
  #     implementation-guides:
  #       hl7_fhir_r4_core:
  #         name: hl7.fhir.r4.core
  #         version: 4.0.1
  #       fhir_r4_wales_psom:
  #         name: fhir.r4.wales.psom
  #         version: 1.0.0-rc3
